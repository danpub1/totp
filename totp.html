<!DOCTYPE html>
<html lang="en">
    <!-- Started life as: https://gist.github.com/rafaelsq/e6a84d2f9b487917115362e39032d528 -->
    <head>
        <meta charset="utf-8">
        <meta name="description" content="totp - time-based one-time password">
        <meta name="author" content="">
        <title>totp - time-based one-time password</title>

        <style>
            body {
                font-family: 'Fira Mono', 'Fira Code', Cousine, Consolas, 'Courier New', 'Lucida Sans Typewriter', Monaco, 'Andale Mono', Courier, monospace; 
                font-size: 13px; 
                text-align: left; 
                line-height: 1.30;
                font-variant-ligatures: none;
            }
            .leader { font-size: 13px; }
            .spacer { font-size: 7px; }
            .footer { font-size: 11px; }
            .bodydiv { margin:0 auto; width:800px; }
            .title {  margin-bottom:0; margin-top:0 }
        </style>
    </head>
    <body>
        <div class="bodydiv" >
            <h2 class="title">totp</h2>
            <b class="leader">Time-based One-Time Password</b>
            <div class="spacer">&nbsp;</div>
            <div><b>Secret:&nbsp;&nbsp;&nbsp;</b> <input id="secret" type="text" value="" size="40"/></div>
            <div><b>HMAC:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b> <select name="hmac" id="hmac">
                <option value="SHA-1">SHA-1</option>
                <option value="SHA-256">SHA-256</option>
                <option value="SHA-512">SHA-512</option>
            </select></div>
            <div><b>Length:&nbsp;&nbsp;&nbsp;</b> <input id="codeLen" type="text" value="6" size="1"/></div>
            <div><b>Window:&nbsp;&nbsp;&nbsp;</b> <input id="windowSize" type="text" value="30" size="4"/></div>
            <div><b>Remaining:</b> <span id="remaining"></span></div>
            <div><b>Code:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b> <span id="code"></span></div>
            <div class="spacer">&nbsp;</div>
            <div class="footer">&copy; 2021 danpub1</div>
            <div class="footer">Based on <a href="https://gist.github.com/rafaelsq/e6a84d2f9b487917115362e39032d528">https://gist.github.com/rafaelsq/e6a84d2f9b487917115362e39032d528</a></div>
        <div>
        <script>
var alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567abcdefghijklmnopqrstuvwxyz234567'

function hexToBuf(hex) {
  bytes = new Uint8Array(hex.length/2)
  for (let c = 0; c < hex.length; c += 2) {
	  bytes[c/2] = parseInt(hex.substr(c, 2), 16)
  }
  return bytes;
}

function lPad(str, len, pad) {
  if (len + 1 >= str.length) {
	  str = Array(len + 1 - str.length).join(pad) + str
  }
  return str
}

function bufToBase32(buf) {
  var bits = ''
  for (var ii = 0; ii < buf.length; ii++) {
	  bits += lPad(buf[ii].toString(2), 8, '0')
  }
  
  if (bits.length % 5 != 0) {
	  bits += '0000'.substr(0, 5 - bits.length % 5)
  }
  //console.log(bits.length + " bits: " + bits)

  var base32 = ''
  for (var ii = 0; ii < bits.length; ii += 5) {
	  base32 += alphabet.substr(parseInt(bits.substr(ii, 5), 2), 1)
  }
  //console.log(base32.length + " base32: " + base32)
  
  return base32;
}

function base32ToHex(base32) {

  var bits = ''
  for (var ii = 0; ii < base32.length; ii++) {
	  var val = alphabet.indexOf(base32.charAt(ii)) % 32
	  if (val >= 0) {
		  bits += lPad(val.toString(2), 5, '0')
	  }
  }
  //console.log(bits.length + "bits: " + bits)
  
  var hex = ''
  for (var ii = 0; ii + 7 < bits.length; ii += 8) {
	  hex += lPad(parseInt(bits.substr(ii, 8), 2).toString(16),2,'0')
  }

  //console.log(hex.length + "hex: " + hex)
  return hex
}

function getCounter(s) {
  return lPad(Math.floor(s).toString(16), 16, '0')
}

function getTimeCounter(windowSize) {
  const epoch = Math.round(new Date().getTime() / 1000.0)
  return getCounter(epoch / windowSize);
}

function getRemaining(windowSize) {
  const epoch = Math.round(new Date().getTime() / 1000.0)
  return windowSize - (epoch % windowSize + 1)
}

async function getOTP(secret, mac, codeLen, windowSize) {
  const keyData = hexToBuf(base32ToHex(secret))
  const data = hexToBuf(getTimeCounter(windowSize))
  
  if (keyData.length != 0) {
	  const key = await crypto.subtle.importKey('raw', keyData, {name: 'HMAC', hash: mac}, false, ['sign'])
	  const signature = await crypto.subtle.sign({name: 'HMAC', hash: mac}, key, data)

	  var arr = new Uint8Array(signature)
	  var offset = arr[arr.length - 1] & 0xf
	  var binary = ((arr[offset] & 0x7f) << 24) | ((arr[offset + 1] & 0xff) << 16) | ((arr[offset + 2] & 0xff) << 8) | (arr[offset + 3] & 0xff)
	  return lPad((binary % Math.pow(10, codeLen)).toString(), codeLen, '0')
  } else {
	  return '';
  }
}

function generateSecret() {
  var randBytes = new Uint8Array(20)        
  window.crypto.getRandomValues(randBytes)
  document.getElementById('secret').value = bufToBase32(randBytes)
}

function refreshSecret() {
  newSecret = document.getElementById('secret').value;
  var re = new RegExp(/^otpauth:\/\/totp\/[^?]+\?/)
  if (re.test(newSecret)) {
	  var params = newSecret.substr(re.exec(newSecret)[0].length).split('&')
	  for (var ii = 0; ii < params.length; ii++) {
		  if (params[ii].startsWith('secret=')) {
			  document.getElementById('secret').value = params[ii].substr('secret='.length);
		  } else if (params[ii].startsWith('algorithm=')) {
			  var algorithm = params[ii].substr('algorithm='.length);
			  if (algorithm === 'SHA1') {
				  document.getElementById('hmac').value = 'SHA-1'
			  } else if (algorithm === 'SHA256') {
				  document.getElementById('hmac').value = 'SHA-256'
			  } else if (algorithm === 'SHA512') {
				  document.getElementById('hmac').value = 'SHA-512'
			  }
		  } else if (params[ii].startsWith('digits=')) {
			  var digits = parseInt(params[ii].substr('digits='.length))
			  document.getElementById('codeLen').value = digits
		  } else if (params[ii].startsWith('period=')) {
			  var period = parseInt(params[ii].substr('period='.length))
			  document.getElementById('windowSize').value = period
		  }
	  }
  } else {
	  document.getElementById('secret').value = newSecret;
  }
}

function refresh() {
  //console.log(document.getElementById('secret').value)
  //console.log(bufToBase32(hexToBuf(base32ToHex(document.getElementById('secret').value))))
  const windowSize = parseInt(document.getElementById('windowSize').value, 10)
  const codeLen = parseInt(document.getElementById('codeLen').value, 10)
  const mac = document.getElementById('hmac').value
  getOTP(document.getElementById('secret').value, mac, codeLen, windowSize).then(code => {document.getElementById('code').innerText = code}).catch(alert)
  var remaining = getRemaining(windowSize)
  document.getElementById('remaining').innerText = remaining;
}

function refreshRemaining() {
  const windowSize = parseInt(document.getElementById('windowSize').value, 10)
  var remaining = getRemaining(windowSize)
  document.getElementById('remaining').innerText = remaining;
  if (remaining == windowSize - 1) refresh()
}

generateSecret()
document.getElementById('secret').addEventListener('change', e => refreshSecret())
document.getElementById('windowSize').addEventListener('change', e => refresh())
document.getElementById('codeLen').addEventListener('change', e => refresh())
document.getElementById('hmac').addEventListener('change', e => refresh())
setInterval(() => refreshRemaining(), 1000)
refresh()
        </script>
    </body>
</html>